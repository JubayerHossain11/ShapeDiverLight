{"id":"node_modules/@shapediver/viewer.rendering-engine-threejs.standard/dist/managers/BeautyRenderingManager.js","dependencies":[{"name":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js.map","includedInParent":true,"mtime":1706542086679},{"name":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\src\\managers\\BeautyRenderingManager.ts","includedInParent":true,"mtime":1706542087224},{"name":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\package.json","includedInParent":true,"mtime":1706542184022},{"name":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\package.json","includedInParent":true,"mtime":1706542086641},{"name":"three","loc":{"line":23,"column":35,"index":1034},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\three\\build\\three.module.js"},{"name":"@shapediver/viewer.shared.services","loc":{"line":24,"column":41,"index":1087},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.shared.services\\dist\\index.js"},{"name":"../three/postprocessing/EffectComposer","loc":{"line":25,"column":33,"index":1160},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\postprocessing\\EffectComposer.js"},{"name":"../three/postprocessing/RenderPass","loc":{"line":26,"column":29,"index":1233},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\postprocessing\\RenderPass.js"},{"name":"../three/postprocessing/SSAARenderPass","loc":{"line":27,"column":33,"index":1306},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\postprocessing\\SSAARenderPass.js"},{"name":"../three/postprocessing/ShaderPass","loc":{"line":28,"column":29,"index":1379},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\postprocessing\\ShaderPass.js"},{"name":"../three/shaders/GammaCorrectionShader","loc":{"line":29,"column":40,"index":1459},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\shaders\\GammaCorrectionShader.js"},{"name":"../three/postprocessing/SAOPass","loc":{"line":30,"column":26,"index":1529},"parent":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\managers\\BeautyRenderingManager.js","resolved":"F:\\UpworkProjects\\ShapeDiverLight\\ShapeDiverLight\\shapediverlight.client\\node_modules\\@shapediver\\viewer.rendering-engine-threejs.standard\\dist\\three\\postprocessing\\SAOPass.js"}],"generated":{"js":"\"use strict\";\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n});\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.BeautyRenderingManager = void 0;\r\nconst THREE = __importStar(require(\"three\"));\r\nconst viewer_shared_services_1 = require(\"@shapediver/viewer.shared.services\");\r\nconst EffectComposer_1 = require(\"../three/postprocessing/EffectComposer\");\r\nconst RenderPass_1 = require(\"../three/postprocessing/RenderPass\");\r\nconst SSAARenderPass_1 = require(\"../three/postprocessing/SSAARenderPass\");\r\nconst ShaderPass_1 = require(\"../three/postprocessing/ShaderPass\");\r\nconst GammaCorrectionShader_1 = require(\"../three/shaders/GammaCorrectionShader\");\r\nconst SAOPass_1 = require(\"../three/postprocessing/SAOPass\");\r\nclass BeautyRenderingManager {\r\n    // #endregion Properties (12)\r\n    // #region Constructors (1)\r\n    constructor(_renderingEngine) {\r\n        this._renderingEngine = _renderingEngine;\r\n        // #region Properties (12)\r\n        this._systemInfo = viewer_shared_services_1.SystemInfo.instance;\r\n        this._beautyRenderingActive = false;\r\n        this._beautyRenderingDurationActive = 0;\r\n        this._beautyRenderingTimeout = null;\r\n        this._lastTime = 0;\r\n        this._lightSizeUVEnd = 0.15;\r\n        this._lightSizeUVStart = 0.025;\r\n    }\r\n    // #endregion Constructors (1)\r\n    // #region Public Accessors (6)\r\n    get beautyRenderingActive() {\r\n        return this._beautyRenderingActive;\r\n    }\r\n    set beautyRenderingActive(value) {\r\n        this._beautyRenderingActive = value;\r\n    }\r\n    get beautyRenderingDurationActive() {\r\n        return this._beautyRenderingDurationActive;\r\n    }\r\n    set beautyRenderingDurationActive(value) {\r\n        this._beautyRenderingDurationActive = value;\r\n    }\r\n    get beautyRenderingTimeout() {\r\n        return this._beautyRenderingTimeout;\r\n    }\r\n    set beautyRenderingTimeout(value) {\r\n        this._beautyRenderingTimeout = value;\r\n    }\r\n    // #endregion Public Accessors (6)\r\n    // #region Public Methods (7)\r\n    activateBeautyRenderShaders() {\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n    assignOutputEncoding(encoding) {\r\n        if (encoding === 3001) {\r\n            if (!this._effectComposer.passes.includes(this._gammaCorrectionPass))\r\n                this._effectComposer.addPass(this._gammaCorrectionPass);\r\n        }\r\n        else {\r\n            if (this._effectComposer.passes.includes(this._gammaCorrectionPass))\r\n                this._effectComposer.removePass(this._gammaCorrectionPass);\r\n        }\r\n    }\r\n    deactivateBeautyRenderShaders() {\r\n        this._beautyRenderingTimeout = null;\r\n        this._beautyRenderingActive = false;\r\n        this._beautyRenderingDurationActive = 0;\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart, 0.1);\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n    init() {\r\n        const tempCamera = new THREE.PerspectiveCamera();\r\n        var size = this._renderingEngine.renderer.getSize(new THREE.Vector2());\r\n        const renderTarget = new THREE.WebGLRenderTarget(size.width, size.height, {\r\n            minFilter: THREE.LinearFilter,\r\n            magFilter: THREE.LinearFilter,\r\n            format: THREE.RGBAFormat,\r\n            stencilBuffer: false,\r\n            type: THREE.FloatType\r\n        });\r\n        renderTarget.texture.name = 'EffectComposer.rt1';\r\n        this._effectComposer = new EffectComposer_1.EffectComposer(this._renderingEngine.renderer, renderTarget);\r\n        this._renderPass = new RenderPass_1.RenderPass(this._renderingEngine.scene, tempCamera);\r\n        //this._effectComposer.addPass(this._renderPass);\r\n        this._ssaaPass = new SSAARenderPass_1.SSAARenderPass(this._renderingEngine.scene, tempCamera, this._renderingEngine.renderer.getClearColor(new THREE.Color()), this._renderingEngine.renderer.getClearAlpha());\r\n        this._ssaaPass.sampleLevel = 2;\r\n        this._effectComposer.addPass(this._ssaaPass);\r\n        this._saoPass = new SAOPass_1.SAOPass(this._renderingEngine.scene, tempCamera, true, true);\r\n        const saoRenderFunction = this._saoPass.render.bind(this._saoPass);\r\n        this._saoPass.render = (renderer, writeBuffer, readBuffer, deltaTime, maskActive) => {\r\n            const materialsNotRenderer = [];\r\n            this._renderingEngine.scene.traverse(function (object) {\r\n                if (object.visible === true) {\r\n                    if (object instanceof THREE.Mesh && object.material) {\r\n                        if (object.material instanceof THREE.MeshPhysicalMaterial && object.material.transparent) {\r\n                            materialsNotRenderer.push(object);\r\n                            object.visible = false;\r\n                        }\r\n                    }\r\n                    if (object instanceof THREE.Line || object instanceof THREE.LineLoop || object instanceof THREE.LineSegments) {\r\n                        materialsNotRenderer.push(object);\r\n                        object.visible = false;\r\n                    }\r\n                    if (object.userData.ambientOcclusion === false) {\r\n                        materialsNotRenderer.push(object);\r\n                        object.visible = false;\r\n                    }\r\n                }\r\n            });\r\n            saoRenderFunction(renderer, writeBuffer, readBuffer, deltaTime, maskActive);\r\n            for (let i = 0; i < materialsNotRenderer.length; i++)\r\n                materialsNotRenderer[i].visible = true;\r\n        };\r\n        this._effectComposer.addPass(this._saoPass);\r\n        this._saoPass.params.output = 0;\r\n        this._saoPass.params.saoBias = 0.5;\r\n        this._saoPass.params.saoIntensity = this._renderingEngine.ambientOcclusionIntensity * 0.01;\r\n        this._saoPass.params.saoScale = 1;\r\n        this._saoPass.params.saoKernelRadius = 100;\r\n        this._saoPass.params.saoMinResolution = 0;\r\n        this._saoPass.params.saoBlur = true;\r\n        this._saoPass.params.saoBlurRadius = 8;\r\n        this._saoPass.params.saoBlurStdDev = 4;\r\n        this._saoPass.params.saoBlurDepthCutoff = 0.001;\r\n        this._gammaCorrectionPass = new ShaderPass_1.ShaderPass(GammaCorrectionShader_1.GammaCorrectionShader);\r\n        this._effectComposer.addPass(this._gammaCorrectionPass);\r\n        this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVEnd, 1.0);\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n    render(time, camera, width, height) {\r\n        const percentage = this.setShaderProperties();\r\n        if (((this._renderingEngine.ambientOcclusion && this._renderingEngine.ambientOcclusionIntensity > 0.0) && !((this._systemInfo.isMacOS && this._systemInfo.isChrome) || this._systemInfo.isIOS || this._systemInfo.isMobile || this._systemInfo.isSafari))) {\r\n            this._ssaaPass.clearColor = this._renderingEngine.renderer.getClearColor(new THREE.Color());\r\n            this._ssaaPass.clearAlpha = this._renderingEngine.renderer.getClearAlpha();\r\n            this._saoPass.params.saoIntensity = this._renderingEngine.ambientOcclusionIntensity;\r\n            const saoIntensity = this._saoPass.params.saoIntensity * 0.0025;\r\n            this._saoPass.params.saoIntensity = percentage * saoIntensity;\r\n            // if passes changed, adapt https://shapediver.atlassian.net/browse/SS-2954\r\n            this._renderPass.camera = camera;\r\n            this._saoPass.camera = camera;\r\n            this._ssaaPass.camera = camera;\r\n            this._gammaCorrectionPass.setSize(width, height);\r\n            this._saoPass.setSize(width, height);\r\n            this._ssaaPass.setSize(width, height);\r\n            this._effectComposer.setSize(width, height);\r\n            this._effectComposer.render(time);\r\n            this._saoPass.params.saoIntensity = saoIntensity;\r\n        }\r\n        else {\r\n            this._renderingEngine.renderer.render(this._renderingEngine.scene, camera);\r\n        }\r\n    }\r\n    startBeautyRenderCountdown() {\r\n        this._beautyRenderingTimeout = setTimeout(() => {\r\n            this._beautyRenderingActive = true;\r\n            this._beautyRenderingDurationActive = 0;\r\n            this.activateBeautyRenderShaders();\r\n        }, this._renderingEngine.beautyRenderDelay);\r\n    }\r\n    stopBeautyRenderCountdown() {\r\n        if (this.beautyRenderingTimeout)\r\n            clearTimeout(this.beautyRenderingTimeout);\r\n        this.deactivateBeautyRenderShaders();\r\n    }\r\n    // #endregion Public Methods (7)\r\n    // #region Private Methods (1)\r\n    setShaderProperties() {\r\n        const deltaTime = Math.min(this._beautyRenderingDurationActive, this._renderingEngine.beautyRenderBlendingDuration);\r\n        const percentage = deltaTime / this._renderingEngine.beautyRenderBlendingDuration;\r\n        if (percentage < 0.25) {\r\n            const percentageMapped = percentage / 0.25;\r\n            this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart, percentageMapped);\r\n        }\r\n        else {\r\n            const percentageMapped = (percentage - 0.25) / (1 - 0.25);\r\n            // this._lightSizeUVStart -> this._lightSizeUVEnd\r\n            this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart + (this._lightSizeUVEnd - this._lightSizeUVStart) * percentageMapped, 1.0);\r\n        }\r\n        return percentage;\r\n    }\r\n}\r\nexports.BeautyRenderingManager = BeautyRenderingManager;\r\n"},"sourceMaps":{"js":{"version":3,"file":"BeautyRenderingManager.js","sourceRoot":"","sources":["../../src/managers/BeautyRenderingManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,6CAA8B;AAC9B,+EAA+D;AAG/D,2EAAwE;AACxE,mEAAgE;AAChE,2EAAwE;AACxE,mEAAgE;AAChE,kFAA+E;AAC/E,6DAAyD;AAIzD,MAAa,sBAAsB;IAiB/B,6BAA6B;IAE7B,2BAA2B;IAE3B,YACqB,gBAAiC;QAAjC,qBAAgB,GAAhB,gBAAgB,CAAiB;QArBtD,0BAA0B;QAET,gBAAW,GAAe,mCAAU,CAAC,QAAQ,CAAC;QAEvD,2BAAsB,GAAY,KAAK,CAAC;QACxC,mCAA8B,GAAW,CAAC,CAAC;QAC3C,4BAAuB,GAA0B,IAAI,CAAC;QAEtD,cAAS,GAAW,CAAC,CAAC;QACtB,oBAAe,GAAG,IAAI,CAAC;QACvB,sBAAiB,GAAG,KAAK,CAAC;IAY/B,CAAC;IAEJ,8BAA8B;IAE9B,+BAA+B;IAE/B,IAAW,qBAAqB;QAC5B,OAAO,IAAI,CAAC,sBAAsB,CAAC;IACvC,CAAC;IAED,IAAW,qBAAqB,CAAC,KAAc;QAC3C,IAAI,CAAC,sBAAsB,GAAG,KAAK,CAAC;IACxC,CAAC;IAED,IAAW,6BAA6B;QACpC,OAAO,IAAI,CAAC,8BAA8B,CAAC;IAC/C,CAAC;IAED,IAAW,6BAA6B,CAAC,KAAa;QAClD,IAAI,CAAC,8BAA8B,GAAG,KAAK,CAAC;IAChD,CAAC;IAED,IAAW,sBAAsB;QAC7B,OAAO,IAAI,CAAC,uBAAuB,CAAC;IACxC,CAAC;IAED,IAAW,sBAAsB,CAAC,KAA4B;QAC1D,IAAI,CAAC,uBAAuB,GAAG,KAAK,CAAC;IACzC,CAAC;IAED,kCAAkC;IAElC,6BAA6B;IAEtB,2BAA2B;QAC9B,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,GAAG,KAAK,CAAC,YAAY,CAAC;QACnE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC;QAC5D,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,eAAe,EAAE,CAAC;IAC3D,CAAC;IAEM,oBAAoB,CAAC,QAAgB;QACxC,IAAG,QAAQ,KAAK,IAAI,EAAE;YAClB,IAAG,CAAC,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,oBAAoB,CAAC;gBAC/D,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;SAC/D;aAAM;YACH,IAAG,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,oBAAoB,CAAC;gBAC9D,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;SAClE;IACL,CAAC;IAEM,6BAA6B;QAChC,IAAI,CAAC,uBAAuB,GAAG,IAAI,CAAC;QACpC,IAAI,CAAC,sBAAsB,GAAG,KAAK,CAAC;QACpC,IAAI,CAAC,8BAA8B,GAAG,CAAC,CAAC;QACxC,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,GAAG,KAAK,CAAC,gBAAgB,CAAC;QACvE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC;QAC5D,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gBAAgB,CAAC,IAAI,CAAC,iBAAiB,EAAE,GAAG,CAAC,CAAC;QACnF,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,eAAe,EAAE,CAAC;IAC3D,CAAC;IAEM,IAAI;QACP,MAAM,UAAU,GAAG,IAAI,KAAK,CAAC,iBAAiB,EAAE,CAAC;QAEjD,IAAI,IAAI,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;QACvE,MAAM,YAAY,GAAG,IAAI,KAAK,CAAC,iBAAiB,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,EAAE;YACtE,SAAS,EAAE,KAAK,CAAC,YAAY;YAC7B,SAAS,EAAE,KAAK,CAAC,YAAY;YAC7B,MAAM,EAAE,KAAK,CAAC,UAAU;YACxB,aAAa,EAAE,KAAK;YACpB,IAAI,EAAE,KAAK,CAAC,SAAS;SACxB,CAAC,CAAC;QACH,YAAY,CAAC,OAAO,CAAC,IAAI,GAAG,oBAAoB,CAAC;QAEjD,IAAI,CAAC,eAAe,GAAG,IAAI,+BAAc,CAAC,IAAI,CAAC,gBAAgB,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC;QAExF,IAAI,CAAC,WAAW,GAAG,IAAI,uBAAU,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC;QAC3E,iDAAiD;QAEjD,IAAI,CAAC,SAAS,GAAG,IAAI,+BAAc,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,UAAU,EAAE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC,EAAE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,aAAa,EAAE,CAAC,CAAC;QAC9L,IAAI,CAAC,SAAS,CAAC,WAAW,GAAG,CAAC,CAAC;QAE/B,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAE7C,IAAI,CAAC,QAAQ,GAAG,IAAI,iBAAO,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;QAEjF,MAAM,iBAAiB,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAEnE,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,QAA6B,EAAE,WAAoC,EAAE,UAAmC,EAAE,SAAiB,EAAE,UAAmB,EAAE,EAAE;YACxK,MAAM,oBAAoB,GAAqB,EAAE,CAAC;YAClD,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,QAAQ,CAAC,UAAU,MAAM;gBACjD,IAAI,MAAM,CAAC,OAAO,KAAK,IAAI,EAAE;oBACzB,IAAI,MAAM,YAAY,KAAK,CAAC,IAAI,IAAI,MAAM,CAAC,QAAQ,EAAE;wBACjD,IAAI,MAAM,CAAC,QAAQ,YAAY,KAAK,CAAC,oBAAoB,IAAI,MAAM,CAAC,QAAQ,CAAC,WAAW,EAAE;4BACtF,oBAAoB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;4BAClC,MAAM,CAAC,OAAO,GAAG,KAAK,CAAC;yBAC1B;qBACJ;oBACD,IAAG,MAAM,YAAY,KAAK,CAAC,IAAI,IAAI,MAAM,YAAY,KAAK,CAAC,QAAQ,IAAI,MAAM,YAAY,KAAK,CAAC,YAAY,EAAE;wBACzG,oBAAoB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;wBAClC,MAAM,CAAC,OAAO,GAAG,KAAK,CAAC;qBAC1B;oBACD,IAAG,MAAM,CAAC,QAAQ,CAAC,gBAAgB,KAAK,KAAK,EAAE;wBAC3C,oBAAoB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;wBAClC,MAAM,CAAC,OAAO,GAAG,KAAK,CAAC;qBAC1B;iBACJ;YACL,CAAC,CAAC,CAAC;YACH,iBAAiB,CAAC,QAAQ,EAAE,WAAW,EAAE,UAAU,EAAE,SAAS,EAAE,UAAU,CAAC,CAAC;YAC5E,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,oBAAoB,CAAC,MAAM,EAAE,CAAC,EAAE;gBAChD,oBAAoB,CAAC,CAAC,CAAC,CAAC,OAAO,GAAG,IAAI,CAAC;QAC/C,CAAC,CAAA;QAED,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC5C,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;QAChC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,GAAG,GAAG,CAAC;QACnC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC,yBAAyB,GAAG,IAAI,CAAC;QAC3F,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,GAAG,CAAC,CAAC;QAClC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,eAAe,GAAG,GAAG,CAAC;QAC3C,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,gBAAgB,GAAG,CAAC,CAAC;QAE1C,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;QACpC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,aAAa,GAAG,CAAC,CAAC;QACvC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,aAAa,GAAG,CAAC,CAAC;QACvC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,kBAAkB,GAAG,KAAK,CAAC;QAEhD,IAAI,CAAC,oBAAoB,GAAG,IAAI,uBAAU,CAAC,6CAAqB,CAAC,CAAC;QAClE,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;QAExD,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gBAAgB,CAAC,IAAI,CAAC,eAAe,EAAE,GAAG,CAAC,CAAC;QAEjF,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,GAAG,KAAK,CAAC,YAAY,CAAC;QACnE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC;QAC5D,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,eAAe,EAAE,CAAC;IAC3D,CAAC;IAEM,MAAM,CAAC,IAAY,EAAE,MAAoB,EAAE,KAAa,EAAE,MAAc;QAC3E,MAAM,UAAU,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAE9C,IAAG,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,IAAI,IAAI,CAAC,gBAAgB,CAAC,yBAAyB,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,OAAO,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,KAAK,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,EAAE;YACtP,IAAI,CAAC,SAAS,CAAC,UAAU,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC,CAAC;YAC5F,IAAI,CAAC,SAAS,CAAC,UAAU,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,aAAa,EAAE,CAAC;YAE3E,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC,yBAAyB,CAAC;YACpF,MAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,GAAG,MAAM,CAAC;YAChE,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,GAAG,UAAU,GAAG,YAAY,CAAC;YAE9D,2EAA2E;YAC3E,IAAI,CAAC,WAAW,CAAC,MAAM,GAAG,MAAM,CAAC;YACjC,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,MAAM,CAAC;YAC9B,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,MAAM,CAAC;YAE/B,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YACjD,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAA;YACpC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAA;YACrC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YAC5C,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAClC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,GAAG,YAAY,CAAC;SACpD;aAAM;YACH,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,MAAM,CAAC,CAAA;SAC7E;IACL,CAAC;IAEM,0BAA0B;QAC7B,IAAI,CAAC,uBAAuB,GAAG,UAAU,CAAC,GAAG,EAAE;YAC3C,IAAI,CAAC,sBAAsB,GAAG,IAAI,CAAC;YACnC,IAAI,CAAC,8BAA8B,GAAG,CAAC,CAAC;YACxC,IAAI,CAAC,2BAA2B,EAAE,CAAC;QACvC,CAAC,EAAE,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,CAAC,CAAC;IAChD,CAAC;IAEM,yBAAyB;QAC5B,IAAI,IAAI,CAAC,sBAAsB;YAC3B,YAAY,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC;QAC9C,IAAI,CAAC,6BAA6B,EAAE,CAAC;IACzC,CAAC;IAED,gCAAgC;IAEhC,8BAA8B;IAEtB,mBAAmB;QACvB,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,8BAA8B,EAAE,IAAI,CAAC,gBAAgB,CAAC,4BAA4B,CAAC,CAAA;QACnH,MAAM,UAAU,GAAG,SAAS,GAAG,IAAI,CAAC,gBAAgB,CAAC,4BAA4B,CAAC;QAElF,IAAI,UAAU,GAAG,IAAI,EAAE;YACnB,MAAM,gBAAgB,GAAG,UAAU,GAAG,IAAI,CAAC;YAC3C,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gBAAgB,CAAC,IAAI,CAAC,iBAAiB,EAAE,gBAAgB,CAAC,CAAC;SAEnG;aAAM;YACH,MAAM,gBAAgB,GAAG,CAAC,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC;YAC1D,iDAAiD;YACjD,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,gBAAgB,CAAC,IAAI,CAAC,iBAAiB,GAAG,CAAC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,gBAAgB,EAAE,GAAG,CAAC,CAAC;SAC3J;QACD,OAAO,UAAU,CAAC;IACtB,CAAC;CAGJ;AA5ND,wDA4NC","sourcesContent":["import * as THREE from 'three'\r\nimport { SystemInfo } from '@shapediver/viewer.shared.services'\r\n\r\nimport { RenderingEngine } from '../RenderingEngine'\r\nimport { EffectComposer } from '../three/postprocessing/EffectComposer';\r\nimport { RenderPass } from '../three/postprocessing/RenderPass';\r\nimport { SSAARenderPass } from '../three/postprocessing/SSAARenderPass';\r\nimport { ShaderPass } from '../three/postprocessing/ShaderPass';\r\nimport { GammaCorrectionShader } from '../three/shaders/GammaCorrectionShader';\r\nimport { SAOPass } from '../three/postprocessing/SAOPass'\r\nimport { IManager } from '@shapediver/viewer.rendering-engine.rendering-engine';\r\n\r\n\r\nexport class BeautyRenderingManager implements IManager {\r\n    // #region Properties (12)\r\n\r\n    private readonly _systemInfo: SystemInfo = SystemInfo.instance;\r\n\r\n    private _beautyRenderingActive: boolean = false;\r\n    private _beautyRenderingDurationActive: number = 0;\r\n    private _beautyRenderingTimeout: NodeJS.Timeout | null = null;\r\n    private _effectComposer!: EffectComposer;\r\n    private _lastTime: number = 0;\r\n    private _lightSizeUVEnd = 0.15;\r\n    private _lightSizeUVStart = 0.025;\r\n    private _renderPass!: RenderPass;\r\n    private _saoPass!: SAOPass;\r\n    private _ssaaPass!: SSAARenderPass;\r\n    private _gammaCorrectionPass!: ShaderPass\r\n\r\n    // #endregion Properties (12)\r\n\r\n    // #region Constructors (1)\r\n\r\n    constructor(\r\n        private readonly _renderingEngine: RenderingEngine\r\n    ) {}\r\n\r\n    // #endregion Constructors (1)\r\n\r\n    // #region Public Accessors (6)\r\n\r\n    public get beautyRenderingActive(): boolean {\r\n        return this._beautyRenderingActive;\r\n    }\r\n\r\n    public set beautyRenderingActive(value: boolean) {\r\n        this._beautyRenderingActive = value;\r\n    }\r\n\r\n    public get beautyRenderingDurationActive(): number {\r\n        return this._beautyRenderingDurationActive;\r\n    }\r\n\r\n    public set beautyRenderingDurationActive(value: number) {\r\n        this._beautyRenderingDurationActive = value;\r\n    }\r\n\r\n    public get beautyRenderingTimeout(): NodeJS.Timeout | null {\r\n        return this._beautyRenderingTimeout;\r\n    }\r\n\r\n    public set beautyRenderingTimeout(value: NodeJS.Timeout | null) {\r\n        this._beautyRenderingTimeout = value;\r\n    }\r\n\r\n    // #endregion Public Accessors (6)\r\n\r\n    // #region Public Methods (7)\r\n\r\n    public activateBeautyRenderShaders() {\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n\r\n    public assignOutputEncoding(encoding: number) {\r\n        if(encoding === 3001) {\r\n            if(!this._effectComposer.passes.includes(this._gammaCorrectionPass))\r\n                this._effectComposer.addPass(this._gammaCorrectionPass);\r\n        } else {\r\n            if(this._effectComposer.passes.includes(this._gammaCorrectionPass))\r\n                this._effectComposer.removePass(this._gammaCorrectionPass);\r\n        }\r\n    }\r\n\r\n    public deactivateBeautyRenderShaders() {\r\n        this._beautyRenderingTimeout = null;\r\n        this._beautyRenderingActive = false;\r\n        this._beautyRenderingDurationActive = 0;\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart, 0.1);\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n\r\n    public init(): void {\r\n        const tempCamera = new THREE.PerspectiveCamera();\r\n\r\n        var size = this._renderingEngine.renderer.getSize(new THREE.Vector2());\r\n        const renderTarget = new THREE.WebGLRenderTarget(size.width, size.height, {\r\n            minFilter: THREE.LinearFilter,\r\n            magFilter: THREE.LinearFilter,\r\n            format: THREE.RGBAFormat,\r\n            stencilBuffer: false,\r\n            type: THREE.FloatType\r\n        });\r\n        renderTarget.texture.name = 'EffectComposer.rt1';\r\n\r\n        this._effectComposer = new EffectComposer(this._renderingEngine.renderer, renderTarget);\r\n\r\n        this._renderPass = new RenderPass(this._renderingEngine.scene, tempCamera);\r\n        //this._effectComposer.addPass(this._renderPass);\r\n\r\n        this._ssaaPass = new SSAARenderPass(this._renderingEngine.scene, tempCamera, this._renderingEngine.renderer.getClearColor(new THREE.Color()), this._renderingEngine.renderer.getClearAlpha());\r\n        this._ssaaPass.sampleLevel = 2;\r\n        \r\n        this._effectComposer.addPass(this._ssaaPass);\r\n\r\n        this._saoPass = new SAOPass(this._renderingEngine.scene, tempCamera, true, true);\r\n\r\n        const saoRenderFunction = this._saoPass.render.bind(this._saoPass);\r\n\r\n        this._saoPass.render = (renderer: THREE.WebGLRenderer, writeBuffer: THREE.WebGLRenderTarget, readBuffer: THREE.WebGLRenderTarget, deltaTime: number, maskActive: boolean) => {\r\n            const materialsNotRenderer: THREE.Object3D[] = [];\r\n            this._renderingEngine.scene.traverse(function (object) {\r\n                if (object.visible === true) {\r\n                    if (object instanceof THREE.Mesh && object.material) {\r\n                        if (object.material instanceof THREE.MeshPhysicalMaterial && object.material.transparent) {\r\n                            materialsNotRenderer.push(object);\r\n                            object.visible = false;\r\n                        }\r\n                    }\r\n                    if(object instanceof THREE.Line || object instanceof THREE.LineLoop || object instanceof THREE.LineSegments) {\r\n                        materialsNotRenderer.push(object);\r\n                        object.visible = false;\r\n                    }\r\n                    if(object.userData.ambientOcclusion === false) {\r\n                        materialsNotRenderer.push(object);\r\n                        object.visible = false;\r\n                    }\r\n                }\r\n            });\r\n            saoRenderFunction(renderer, writeBuffer, readBuffer, deltaTime, maskActive);\r\n            for (let i = 0; i < materialsNotRenderer.length; i++)\r\n                materialsNotRenderer[i].visible = true;\r\n        }\r\n\r\n        this._effectComposer.addPass(this._saoPass);\r\n        this._saoPass.params.output = 0;\r\n        this._saoPass.params.saoBias = 0.5;\r\n        this._saoPass.params.saoIntensity = this._renderingEngine.ambientOcclusionIntensity * 0.01;\r\n        this._saoPass.params.saoScale = 1;\r\n        this._saoPass.params.saoKernelRadius = 100;\r\n        this._saoPass.params.saoMinResolution = 0;\r\n\r\n        this._saoPass.params.saoBlur = true;\r\n        this._saoPass.params.saoBlurRadius = 8;\r\n        this._saoPass.params.saoBlurStdDev = 4;\r\n        this._saoPass.params.saoBlurDepthCutoff = 0.001;\r\n\r\n        this._gammaCorrectionPass = new ShaderPass(GammaCorrectionShader);\r\n        this._effectComposer.addPass(this._gammaCorrectionPass);\r\n\r\n        this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVEnd, 1.0);\r\n\r\n        this._renderingEngine.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n        this._renderingEngine.renderer.shadowMap.needsUpdate = true;\r\n        this._renderingEngine.materialLoader.updateMaterials();\r\n    }\r\n\r\n    public render(time: number, camera: THREE.Camera, width: number, height: number) {\r\n        const percentage = this.setShaderProperties();\r\n\r\n        if(((this._renderingEngine.ambientOcclusion && this._renderingEngine.ambientOcclusionIntensity > 0.0) && !((this._systemInfo.isMacOS && this._systemInfo.isChrome) || this._systemInfo.isIOS || this._systemInfo.isMobile || this._systemInfo.isSafari))) {\r\n            this._ssaaPass.clearColor = this._renderingEngine.renderer.getClearColor(new THREE.Color());      \r\n            this._ssaaPass.clearAlpha = this._renderingEngine.renderer.getClearAlpha();\r\n    \r\n            this._saoPass.params.saoIntensity = this._renderingEngine.ambientOcclusionIntensity;\r\n            const saoIntensity = this._saoPass.params.saoIntensity * 0.0025;\r\n            this._saoPass.params.saoIntensity = percentage * saoIntensity;\r\n\r\n            // if passes changed, adapt https://shapediver.atlassian.net/browse/SS-2954\r\n            this._renderPass.camera = camera;\r\n            this._saoPass.camera = camera;\r\n            this._ssaaPass.camera = camera;\r\n        \r\n            this._gammaCorrectionPass.setSize(width, height);\r\n            this._saoPass.setSize(width, height)\r\n            this._ssaaPass.setSize(width, height)\r\n            this._effectComposer.setSize(width, height);\r\n            this._effectComposer.render(time);\r\n            this._saoPass.params.saoIntensity = saoIntensity;\r\n        } else {\r\n            this._renderingEngine.renderer.render(this._renderingEngine.scene, camera)\r\n        }\r\n    }\r\n\r\n    public startBeautyRenderCountdown() {\r\n        this._beautyRenderingTimeout = setTimeout(() => {\r\n            this._beautyRenderingActive = true;\r\n            this._beautyRenderingDurationActive = 0;\r\n            this.activateBeautyRenderShaders();\r\n        }, this._renderingEngine.beautyRenderDelay);\r\n    }\r\n\r\n    public stopBeautyRenderCountdown() {\r\n        if (this.beautyRenderingTimeout)\r\n            clearTimeout(this.beautyRenderingTimeout);\r\n        this.deactivateBeautyRenderShaders();\r\n    }\r\n\r\n    // #endregion Public Methods (7)\r\n\r\n    // #region Private Methods (1)\r\n\r\n    private setShaderProperties() {\r\n        const deltaTime = Math.min(this._beautyRenderingDurationActive, this._renderingEngine.beautyRenderBlendingDuration)\r\n        const percentage = deltaTime / this._renderingEngine.beautyRenderBlendingDuration;\r\n\r\n        if (percentage < 0.25) {\r\n            const percentageMapped = percentage / 0.25;\r\n            this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart, percentageMapped);\r\n\r\n        } else {\r\n            const percentageMapped = (percentage - 0.25) / (1 - 0.25);\r\n            // this._lightSizeUVStart -> this._lightSizeUVEnd\r\n            this._renderingEngine.materialLoader.updateSoftShadow(this._lightSizeUVStart + (this._lightSizeUVEnd - this._lightSizeUVStart) * percentageMapped, 1.0);\r\n        }\r\n        return percentage;\r\n    }\r\n\r\n    // #endregion Private Methods (1)\r\n}"]}},"error":null,"hash":"fffc84a90699e43cf9399bae46c5dbe7","cacheData":{"env":{}}}